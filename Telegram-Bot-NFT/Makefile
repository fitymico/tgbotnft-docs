# ================== Telegram-Bot-NFT Makefile ==================
# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Python –±–æ—Ç–æ–º –∏ TypeScript API

SHELL := /bin/bash
VENV := venv
PYTHON := $(VENV)/bin/python
PIP := $(VENV)/bin/pip

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_DIR := $(shell pwd)
MESSAGE_BOT_DIR := $(PROJECT_DIR)/Message_Bot
GIFT_API_DIR := $(PROJECT_DIR)/Gift_API
SCRIPTS_DIR := $(PROJECT_DIR)/scripts

# PID —Ñ–∞–π–ª—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
TALKBOT_PID := $(PROJECT_DIR)/data/talkbot.pid
GIFTBOT_PID := $(PROJECT_DIR)/data/giftbot.pid

.PHONY: help all install install-python install-node venv clean full-clean \
        start start-talkbot start-giftbot \
        stop stop-talkbot stop-giftbot \
        restart status logs \
        docker-build docker-up docker-down docker-logs docker-restart

# ================== –°–ø—Ä–∞–≤–∫–∞ ==================
help:
	@echo "Telegram-Bot-NFT - Makefile –∫–æ–º–∞–Ω–¥—ã"
	@echo ""
	@echo "–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:"
	@echo "  make all              - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
	@echo ""
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞:"
	@echo "  make install          - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (Python + Node.js)"
	@echo "  make install-python   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
	@echo "  make install-node     - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
	@echo "  make venv             - –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Python"
	@echo ""
	@echo "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏:"
	@echo "  make start            - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –±–æ—Ç—ã"
	@echo "  make start-talkbot    - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ Telegram –±–æ—Ç (aiogram)"
	@echo "  make start-giftbot    - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ Gift API –±–æ—Ç"
	@echo ""
	@echo "  make stop             - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –±–æ—Ç—ã"
	@echo "  make stop-talkbot     - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Telegram –±–æ—Ç"
	@echo "  make stop-giftbot     - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Gift API –±–æ—Ç"
	@echo ""
	@echo "  make restart          - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –±–æ—Ç—ã"
	@echo "  make status           - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–æ–≤"
	@echo "  make logs             - –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏"
	@echo ""
	@echo "Docker:"
	@echo "  make docker-build     - –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑"
	@echo "  make docker-up        - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ Docker"
	@echo "  make docker-down      - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker"
	@echo "  make docker-logs      - –õ–æ–≥–∏ Docker"
	@echo "  make docker-restart   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Docker"
	@echo ""
	@echo "–ü—Ä–æ—á–µ–µ:"
	@echo "  make clean            - –£–¥–∞–ª–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∫—ç—à"
	@echo "  make full-clean       - –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–ª–æ–≥–∏, node_modules, dist)"
	@echo ""
	@echo "–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env (—Å–º. .env.example)"

# ================== –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç ==================
all: install start
	@echo ""
	@echo "üöÄ –ë–æ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω!"

# ================== Docker ==================
DOCKER_DIR := $(PROJECT_DIR)/docker

docker-build:
	@echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
	docker compose -f $(DOCKER_DIR)/docker-compose.yml build

docker-up: docker-build
	@echo "üê≥ –ó–∞–ø—É—Å–∫ –≤ Docker..."
	docker compose -f $(DOCKER_DIR)/docker-compose.yml up -d
	@echo ""
	@echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –≤ Docker!"
	@echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'make docker-logs' –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤"

docker-down:
	@echo "üê≥ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker..."
	docker compose -f $(DOCKER_DIR)/docker-compose.yml down
	@echo "‚úÖ Docker –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

docker-logs:
	docker compose -f $(DOCKER_DIR)/docker-compose.yml logs -f --tail=50

docker-restart: docker-down docker-up
	@echo "‚úÖ Docker –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"

# ================== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ==================
venv:
	@echo "–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
	python3 -m venv $(VENV)
	@echo "–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –≤ $(VENV)/"

install-python: venv
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt
	@echo "Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"

install-node:
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
	cd $(GIFT_API_DIR) && npm install
	@echo "Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"

install: install-python install-node
	@echo ""
	@echo "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"
	@echo ""
	@echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ: make start"

# ================== –ó–∞–ø—É—Å–∫ –±–æ—Ç–æ–≤ ==================
start-talkbot:
	@echo "–ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ (talkbot)..."
	@mkdir -p $(PROJECT_DIR)/data
	@if [ -f $(TALKBOT_PID) ] && kill -0 $$(cat $(TALKBOT_PID)) 2>/dev/null; then \
		echo "Telegram –±–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω (PID: $$(cat $(TALKBOT_PID)))"; \
	else \
		cd $(MESSAGE_BOT_DIR) && \
		source $(PROJECT_DIR)/$(VENV)/bin/activate && \
		set -a && source $(PROJECT_DIR)/.env && set +a && \
		nohup $(PROJECT_DIR)/$(PYTHON) talkbot.py > $(PROJECT_DIR)/data/talkbot.log 2>&1 & \
		echo $$! > $(TALKBOT_PID); \
		echo "Telegram –±–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: $$(cat $(TALKBOT_PID)))"; \
	fi

start-giftbot:
	@echo "–ó–∞–ø—É—Å–∫ Gift API –±–æ—Ç–∞..."
	@mkdir -p $(PROJECT_DIR)/data
	@if [ -f $(GIFTBOT_PID) ] && kill -0 $$(cat $(GIFTBOT_PID)) 2>/dev/null; then \
		echo "Gift API –±–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω (PID: $$(cat $(GIFTBOT_PID)))"; \
	else \
		cd $(GIFT_API_DIR) && \
		set -a && source $(PROJECT_DIR)/.env && set +a && \
		nohup npm run dev > $(PROJECT_DIR)/data/giftbot.log 2>&1 & \
		echo $$! > $(GIFTBOT_PID); \
		echo "Gift API –±–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: $$(cat $(GIFTBOT_PID)))"; \
	fi

start: start-talkbot
	@echo ""
	@echo "‚úÖ –ë–æ—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã!"
	@echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'make logs' –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤"
	@echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'make status' –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞"

# ================== –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–æ–≤ ==================
stop-talkbot:
	@echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ Telegram –±–æ—Ç–∞..."
	@if [ -f $(TALKBOT_PID) ]; then \
		PID=$$(cat $(TALKBOT_PID)); \
		if kill -0 $$PID 2>/dev/null; then \
			kill $$PID; \
			sleep 1; \
			if kill -0 $$PID 2>/dev/null; then \
				echo "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."; \
				kill -9 $$PID; \
			fi; \
			echo "Telegram –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
		else \
			echo "Telegram –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"; \
		fi; \
		rm -f $(TALKBOT_PID); \
	else \
		echo "Telegram –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"; \
	fi

stop-giftbot:
	@echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ Gift API –±–æ—Ç–∞..."
	@if [ -f $(GIFTBOT_PID) ]; then \
		PID=$$(cat $(GIFTBOT_PID)); \
		if kill -0 $$PID 2>/dev/null; then \
			kill $$PID; \
			sleep 1; \
			if kill -0 $$PID 2>/dev/null; then \
				echo "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."; \
				kill -9 $$PID; \
			fi; \
			echo "Gift API –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
		else \
			echo "Gift API –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"; \
		fi; \
		rm -f $(GIFTBOT_PID); \
	else \
		echo "Gift API –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"; \
	fi
	@# –¢–∞–∫–∂–µ —É–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã node –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å
	@pkill -f "dist/giftBot.js" 2>/dev/null || true

stop: stop-talkbot stop-giftbot
	@echo ""
	@echo "‚úÖ –í—Å–µ –±–æ—Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# ================== –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ ==================
restart: stop start
	@echo "‚úÖ –ë–æ—Ç—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã"

# ================== –°—Ç–∞—Ç—É—Å ==================
status:
	@echo "=== –°—Ç–∞—Ç—É—Å –±–æ—Ç–æ–≤ ==="
	@echo ""
	@if [ -f $(TALKBOT_PID) ] && kill -0 $$(cat $(TALKBOT_PID)) 2>/dev/null; then \
		echo "üü¢ Telegram –±–æ—Ç: –∑–∞–ø—É—â–µ–Ω (PID: $$(cat $(TALKBOT_PID)))"; \
	else \
		echo "üî¥ Telegram –±–æ—Ç: –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
	fi
	@if [ -f $(GIFTBOT_PID) ] && kill -0 $$(cat $(GIFTBOT_PID)) 2>/dev/null; then \
		echo "üü¢ Gift API –±–æ—Ç: –∑–∞–ø—É—â–µ–Ω (PID: $$(cat $(GIFTBOT_PID)))"; \
	else \
		echo "üî¥ Gift API –±–æ—Ç: –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
	fi
	@echo ""

# ================== –õ–æ–≥–∏ ==================
logs:
	@echo "=== –õ–æ–≥–∏ –±–æ—Ç–æ–≤ ==="
	@echo ""
	@echo "--- Telegram –±–æ—Ç (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫) ---"
	@if [ -f $(PROJECT_DIR)/data/talkbot.log ]; then \
		tail -20 $(PROJECT_DIR)/data/talkbot.log; \
	else \
		echo "–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
	fi
	@echo ""
	@echo "--- Gift API –±–æ—Ç (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫) ---"
	@if [ -f $(PROJECT_DIR)/data/giftbot.log ]; then \
		tail -20 $(PROJECT_DIR)/data/giftbot.log; \
	else \
		echo "–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
	fi
	@echo ""
	@echo "--- –õ–æ–≥ –ø–æ–∫—É–ø–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫) ---"
	@if [ -f $(PROJECT_DIR)/data/bot.log ]; then \
		tail -20 $(PROJECT_DIR)/data/bot.log; \
	else \
		echo "–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
	fi

# ================== –û—á–∏—Å—Ç–∫–∞ ==================
clean:
	@echo "–û—á–∏—Å—Ç–∫–∞..."
	rm -rf $(VENV)
	rm -rf $(MESSAGE_BOT_DIR)/__pycache__
	rm -rf $(PROJECT_DIR)/__pycache__
	find $(PROJECT_DIR) -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find $(PROJECT_DIR) -type f -name "*.pyc" -delete 2>/dev/null || true
	@echo "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

full-clean: stop clean
	@echo "–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞..."
	@# –£–¥–∞–ª—è–µ–º –ª–æ–≥–∏
	rm -f $(PROJECT_DIR)/data/*.log
	@# –£–¥–∞–ª—è–µ–º PID —Ñ–∞–π–ª—ã
	rm -f $(PROJECT_DIR)/data/*.pid
	@# –£–¥–∞–ª—è–µ–º node_modules –∏ dist
	rm -rf $(GIFT_API_DIR)/node_modules
	rm -rf $(GIFT_API_DIR)/dist
	@echo ""
	@echo "‚úÖ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
	@echo "–î–ª—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: make install"
